# Create the new VM

# NOTE: ALL VMs are kickstarted with a default 50g disk. More disks are added
#       once the operating system is installed, via a subsequen "add disk"
#       vCenter call

pwsh <<'EOF'
$ErrorActionPreference = "Stop"
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterNode.ip} `
    -User "{vmwareVcenterUser.user}" `
    -Password '{vmwareVcenterUser.password}'

if ($? -eq $false) {
    Write-Host "Error: Not connected."
    exit 1
}

$memInMb = {kickstartedVmRamSizeGb}*1024  

if ( "{vmwareEsxiHost.fqn}" -eq "{vmwareVcenterNode.fqn}" ) {
    Write-Host "We're talking to the ESXi host, don't pass the -VMHost arg"
    $vm = New-VM `
        -Name "{kickstartedNode.fqn}" `
        -Datastore "{kickstartVmwareStoragePoolName}" `
        -CoresPerSocket {kickstartedVmCpuCount} `
        -NumCpu {kickstartedVmCpuCount} `
        -DiskMB 51200 `
        -MemoryMB $memInMb `
        -NetworkName "{kickstartedVmNetworkName}" `
        -GuestId '{kickstartedVmGuestType}' `
        -CD 

} else {
    Write-Host "We're talking to a vCenter server, pass the -VMHost arg"
    $storagePool = Get-VMHost -Name '{vmwareEsxiHost.fqn}' | Get-Datastore -Name '{kickstartVmwareStoragePoolName}' 
    
    $vm = New-VM `
        -VMHost "{vmwareEsxiHost.fqn}" `
        -Name "{kickstartedNode.fqn}" `
        -Datastore "$storagePool" `
        -CoresPerSocket {kickstartedVmCpuCount} `
        -NumCpu {kickstartedVmCpuCount} `
        -DiskMB 51200 `
        -MemoryMB $memInMb `
        -NetworkName "{kickstartedVmNetworkName}" `
        -GuestId '{kickstartedVmGuestType}' `
        -CD 

}

EOF

