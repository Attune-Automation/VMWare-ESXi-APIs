# Create the new VM
pwsh <<'EOF'
$ErrorActionPreference = "Stop"
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterServer.ip} `
    -User "{vmwareVcenterUser.user}" `
    -Password '{vmwareVcenterUser.password}'

if ($? -eq $false) {
    Write-Host "Error: Not connected."
    exit 1
}

$cd = Get-VM -Name "{targetServer.fqn}" | Get-CDDrive
$iso = "[{ksVmwareStoragePoolName}] kickstart_isos/kickstart_{targetServer.fqn}.iso"

Set-CDDrive -CD $cd `
    -IsoPath $iso `
    -StartConnected $true `
    -Confirm:$false

EOF