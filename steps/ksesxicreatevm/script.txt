# Create the new VM

# NOTE: ALL VMs are kickstarted with a default 50g disk. More disks are added
#       once the operating system is installed, via a subsequen "add disk"
#       vCenter call

pwsh <<'EOF'
$ErrorActionPreference = "Stop"
Import-Module VMware.VimAutomation.Core

Connect-VIServer {vmwareVcenterServer.ip} `
    -User "{vmwareVcenterUser.user}" `
    -Password '{vmwareVcenterUser.password}'

if ($? -eq $false) {
    Write-Host "Error: Not connected."
    exit 1
}

$memInMb = {ksVmRamSizeGb}*1024

if ( "{vmwareEsxiServer.fqn}" -eq "{vmwareVcenterServer.fqn}" ) {
    Write-Host "We're talking to the ESXi host, don't pass the -VMHost arg"
    $vm = New-VM `
        -Name "{targetServer.fqn}" `
        -Datastore "{ksVmwareStoragePoolName}" `
        -CoresPerSocket {ksVmCpuCount} `
        -NumCpu {ksVmCpuCount} `
        -DiskMB $diskInMb `
        -MemoryMB $memInMb `
        -NetworkName "{ksVmwareNetworkName}" `
        -GuestId '{ksVmwareGuestType}' `
        -CD 

} else {
    Write-Host "We're talking to a vCenter server, pass the -VMHost arg"
    $storagePool = Get-VMHost -Name '{vmwareEsxiServer.fqn}' | Get-Datastore -Name '{ksVmwareStoragePoolName}' 
    
    $vm = New-VM `
        -VMHost "{vmwareEsxiServer.fqn}" `
        -Name "{targetServer.fqn}" `
        -Datastore "$storagePool" `
        -CoresPerSocket {ksVmCpuCount} `
        -NumCpu {ksVmCpuCount} `
        -DiskMB {ksVmDiskSizeMb} `
        -MemoryMB 51200 `
        -NetworkName "{ksVmwareNetworkName}" `
        -GuestId '{ksVmwareGuestType}' `
        -CD 

}

EOF

